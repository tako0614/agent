# MCP Server - OAuth 2.1 Standard Implementation

**æ¨™æº–çš„ãªMCP OAuth 2.1èªè¨¼ã‚’å®Ÿè£…ã—ãŸModel Context Protocolã‚µãƒ¼ãƒãƒ¼ã§ã™ã€‚**

## ğŸŒŸ Overview

ã“ã®MCPã‚µãƒ¼ãƒãƒ¼ã¯ã€MCPå…¬å¼ä»•æ§˜ã«æº–æ‹ ã—ãŸ**OAuth 2.1èªè¨¼**ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™:

- âœ… **RFC 9728**: Protected Resource Metadata (PRM)
- âœ… **RFC 8414**: Authorization Server Metadata
- âœ… **RFC 8707**: Resource Indicators
- âœ… **RFC 7636**: PKCE (Proof Key for Code Exchange)
- âœ… **RFC 7591**: Dynamic Client Registration (DCR)

## ğŸ—ï¸ Features

- ğŸ” **æ¨™æº–OAuth 2.1èªè¨¼**: Authorization Code + PKCE ãƒ•ãƒ­ãƒ¼
- ğŸ« **JWT ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³**: æ¥­ç•Œæ¨™æº–ã®Bearerèªè¨¼
- ğŸ‘¤ **ç‹¬ç«‹ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†**: MCPã‚µãƒ¼ãƒãƒ¼ç‹¬è‡ªã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ 
- ğŸ”‘ **Google OAuthçµ±åˆ**: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼
- ï¿½ **401 + WWW-Authenticate**: æ¨™æº–çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹
- ï¿½ğŸ› ï¸ **Business Tools**: Booking, Product, Order, Form management
- ğŸŒ **REST API**: æ¨™æº–çš„ãªHTTP API
- ğŸ”’ **ã‚¹ã‚³ãƒ¼ãƒ—ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡**: ç´°ã‹ã„æ¨©é™ç®¡ç†

## ğŸš€ Quick Start

è©³ç´°ãªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯ [SETUP_OAUTH.md](./SETUP_OAUTH.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

```bash
# 1. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
cp .dev.vars.example .dev.vars
# .dev.vars ã‚’ç·¨é›†

# 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
cd ../database
npx prisma migrate dev
npx prisma generate

# 3. ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
cd ../mcp-server
npm run dev
```

ã‚µãƒ¼ãƒãƒ¼ã¯ `http://localhost:8788` ã§èµ·å‹•ã—ã¾ã™ã€‚

## ğŸ“¡ OAuth 2.1 Endpoints

### ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | èª¬æ˜ |
|--------------|------|
| `GET /.well-known/oauth-authorization-server` | Authorization Server Metadata (RFC 8414) |
| `GET /.well-known/oauth-protected-resource` | Protected Resource Metadata (RFC 9728) |

### èªå¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | èª¬æ˜ |
|--------------|------|
| `POST /oauth/register` | Dynamic Client Registration (RFC 7591) |
| `GET /oauth/authorize` | èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ (Authorization Code + PKCE) |
| `POST /oauth/token` | ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ãƒ»ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ |
| `GET /oauth/jwks` | JSON Web Key Set (JWTæ¤œè¨¼ç”¨) |

### ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | èª¬æ˜ |
|--------------|------|
| `GET /auth/login/google` | Google OAuth ãƒ­ã‚°ã‚¤ãƒ³ |
| `GET /auth/callback/google` | Google OAuth ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| `GET /auth/me` | ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± |
| `POST /auth/logout` | ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ |

### MCP Tools (èªè¨¼å¿…é ˆ)

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | èª¬æ˜ |
|--------------|------|
| `GET /mcp` | APIæ¦‚è¦ |
| `GET /mcp/tools` | åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«ä¸€è¦§ |
| `GET /mcp/tools/booking/*` | äºˆç´„ç®¡ç† |
| `GET /mcp/tools/product/*` | å•†å“ç®¡ç† |
| `GET /mcp/tools/order/*` | æ³¨æ–‡ç®¡ç† |
| `GET /mcp/tools/form/*` | ãƒ•ã‚©ãƒ¼ãƒ ç®¡ç† |

## ğŸ”’ Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MCP Client   â”‚                                   â”‚ MCP Server   â”‚
â”‚ (Claude etc.)â”‚                                   â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                                  â”‚
       â”‚ 1. GET /.well-known/oauth-protected-resource   â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                                  â”‚
       â”‚ 2. WWW-Authenticate: Bearer resource_metadata= â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                                                  â”‚
       â”‚ 3. GET /.well-known/oauth-authorization-server â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                                  â”‚
       â”‚ 4. Authorization Server Metadata                â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                                                  â”‚
       â”‚ 5. POST /oauth/register (DCR)                   â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                                  â”‚
       â”‚ 6. Client Credentials                           â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                                                  â”‚
       â”‚ 7. GET /oauth/authorize + PKCE challenge        â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                                  â”‚
       â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
       â”‚          â”‚ Google OAuth  â”‚                      â”‚
       â”‚          â”‚ Login         â”‚                      â”‚
       â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
       â”‚                                                  â”‚
       â”‚ 8. Authorization Code                           â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                                                  â”‚
       â”‚ 9. POST /oauth/token + code_verifier            â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                                  â”‚
       â”‚ 10. Access Token (JWT) + Refresh Token          â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                                                  â”‚
       â”‚ 11. GET /mcp/tools/booking                      â”‚
       â”‚     Authorization: Bearer <JWT>                 â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                                  â”‚
       â”‚ 12. API Response                                â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                                                  â”‚
```

## ğŸ”‘ Scopes

| ã‚¹ã‚³ãƒ¼ãƒ— | èª¬æ˜ |
|---------|------|
| `booking:read` | äºˆç´„æƒ…å ±ã®èª­ã¿å–ã‚Š |
| `booking:write` | äºˆç´„ã®ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤ |
| `product:read` | å•†å“æƒ…å ±ã®èª­ã¿å–ã‚Š |
| `product:write` | å•†å“ã®ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤ |
| `order:read` | æ³¨æ–‡æƒ…å ±ã®èª­ã¿å–ã‚Š |
| `order:write` | æ³¨æ–‡ã®ä½œæˆãƒ»æ›´æ–° |
| `form:read` | ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã®èª­ã¿å–ã‚Š |
| `form:write` | ãƒ•ã‚©ãƒ¼ãƒ ã®ä½œæˆãƒ»æŠ•ç¨¿ |

## ğŸ§ª Testing

### 1. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª

```bash
curl http://localhost:8788/.well-known/oauth-authorization-server | jq
curl http://localhost:8788/.well-known/oauth-protected-resource | jq
```

### 2. 401ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ç¢ºèª

```bash
curl -v http://localhost:8788/mcp/tools/booking
```

WWW-Authenticateãƒ˜ãƒƒãƒ€ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã€‚

### 3. OAuth 2.1 ãƒ•ãƒ«ãƒ•ãƒ­ãƒ¼

[SETUP_OAUTH.md](./SETUP_OAUTH.md) ã®ã€ŒOAuth 2.1ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã€‚

## ğŸ“š Documentation

- **[SETUP_OAUTH.md](./SETUP_OAUTH.md)** - è©³ç´°ãªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰
- **[README_OAUTH.md](./README_OAUTH.md)** - OAuth 2.1 APIä»•æ§˜
- [MCP Official Docs](https://modelcontextprotocol.io/docs/specification/authentication) - MCPå…¬å¼èªè¨¼ä»•æ§˜

## ğŸš€ Deployment

### Cloudflare Workers

```bash
# Secretsã®è¨­å®š
wrangler secret put JWT_SECRET
wrangler secret put MCP_GOOGLE_CLIENT_SECRET
wrangler secret put DATABASE_URL

# ãƒ‡ãƒ—ãƒ­ã‚¤
npm run deploy
```

## ğŸ” Security

- âœ… PKCE (S256) å¿…é ˆ
- âœ… JWT ç½²åæ¤œè¨¼
- âœ… ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
- âœ… Redirect URI æ¤œè¨¼
- âš ï¸ æœ¬ç•ªç’°å¢ƒã§ã¯å¼·åŠ›ãªJWT_SECRETã‚’è¨­å®š
- âš ï¸ æœ¬ç•ªç’°å¢ƒã§ã¯HTTPSã‚’ä½¿ç”¨
- âš ï¸ æœ¬ç•ªç’°å¢ƒã§ã¯RS256 (RSAç½²å) ã‚’æ¨å¥¨

## ğŸ“ License

MIT

