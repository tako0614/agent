# AIエージェント モード機能

## 概要

AI Service Builderには3つの動作モードがあり、ユーザーのニーズに応じて切り替えることができます。

## モードの種類

### 1. Chat モード 💬

**用途**: シンプルな質問応答

- 通常の会話形式
- 情報の取得
- 簡単な説明や相談
- 単一の質問に対する回答

**例**:
- 「このサービスは何ができますか?」
- 「予約システムの使い方を教えて」
- 「商品の価格を教えて」

### 2. Agent モード 🤖

**用途**: 自律型AIエージェント - 複雑なタスクを計画的に実行

- タスクを自動的に計画に分解
- ステップバイステップで実行
- 複数のツールを組み合わせて使用
- 実行計画と進捗を可視化

**実行フロー**:
1. **指示**: ユーザーからのリクエストを受け取る
2. **計画**: タスクを実行可能なステップに分解
3. **実行**: 各ステップを順番に実行
4. **成果物**: 最終結果をユーザーに報告

**例**:
- 「ECサイトを作成して、商品を3つ追加して」
- 「予約システムをセットアップして、今週の予約枠を作成して」
- 「フォームを作成して、テストデータを送信して」

**UI表示**:
- ✅ 完了したステップ (緑色のチェックマーク)
- 🔄 実行中のステップ (青色のローディング)
- ⏳ 未実行のステップ (グレー)

### 3. Auto モード ✨

**用途**: 自動切り替え - 状況に応じて最適なモードを選択

- ユーザーのメッセージを分析
- 自動的にChatまたはAgentモードを選択
- 最適な処理方法で応答

**判断基準**:
- シンプルな質問 → Chatモード
- 複雑なタスク → Agentモード

## 使い方

### モード切り替え

画面上部のヘッダーにあるモード選択ボタンをクリック:

```
[💬 Chat] [🤖 Agent] [✨ Auto]
```

### 各モードの選び方

#### Chatモードを選ぶ場合:
- 素早く情報を知りたい
- 簡単な質問がしたい
- 会話を楽しみたい

#### Agentモードを選ぶ場合:
- 複数のステップが必要なタスク
- サービスのセットアップ
- データの一括操作
- 実行プロセスを可視化したい

#### Autoモードを選ぶ場合:
- どのモードが適切か分からない
- 色々な種類の質問やタスクを混在させる
- システムに最適な方法を任せたい

## 技術詳細

### アーキテクチャ

```
Frontend (SolidJS)
├── ModeSelector.tsx      # モード選択UI
├── AgentSteps.tsx        # Agentステップ表示
└── MessageBubble.tsx     # メッセージ表示 (モード情報含む)

Backend (Hono + Cloudflare Workers)
├── modes.ts              # モード判定・実行ロジック
│   ├── determineMode()   # 自動モード判定
│   ├── createPlan()      # 実行計画作成
│   ├── executeAgentMode() # Agentモード実行
│   └── executeChatMode()  # Chatモード実行
└── api/index.ts          # APIエンドポイント
```

### データフロー

1. **フロントエンド** → メッセージ送信 (mode付き)
2. **バックエンド**
   - Autoモードの場合: `determineMode()` で判定
   - Chatモードの場合: `executeChatMode()`
   - Agentモードの場合: 
     - `createPlan()` で実行計画作成
     - `executeAgentMode()` でステップ実行
3. **フロントエンド** ← 応答 (mode, planSteps, currentStep付き)

### API レスポンス形式

#### Chat モード
```json
{
  "id": "msg_123",
  "role": "assistant",
  "content": "応答内容",
  "mode": "chat",
  "createdAt": "2025-10-02T..."
}
```

#### Agent モード
```json
{
  "id": "msg_123",
  "role": "assistant",
  "content": "最終応答内容",
  "mode": "agent",
  "planSteps": [
    "タスクを分析",
    "実行",
    "結果を確認"
  ],
  "currentStep": 3,
  "toolCalls": [
    {
      "name": "product_tool",
      "params": {...},
      "result": {...}
    }
  ],
  "createdAt": "2025-10-02T..."
}
```

## 実装例

### Agentモードでの実行例

**ユーザー**: 「ECサイトをセットアップして、商品を追加して」

**実行計画**:
1. ✅ ECサービスの作成
2. ✅ 商品データの準備
3. ✅ 商品の登録
4. ✅ 動作確認
5. ✅ 結果報告

**各ステップで実行される内容**:
- ステップ1: `product_tool` で商品カタログを初期化
- ステップ2: 商品情報を構造化
- ステップ3: `product_tool(action: 'create')` で商品を登録
- ステップ4: `product_tool(action: 'list')` で確認
- ステップ5: ユーザーに分かりやすく報告

## ベストプラクティス

### ユーザー向け

1. **明確な指示**: Agentモードでは、何をしたいか明確に伝える
   - 良い例: 「予約システムを作成して、明日の10時〜17時の予約枠を1時間ごとに設定して」
   - 悪い例: 「なんか作って」

2. **段階的な操作**: 複雑すぎるタスクは分割する
   - 1つのリクエストは最大5ステップまで

3. **モードの使い分け**:
   - 情報を知りたいだけ → Chat
   - 何かを作成・設定したい → Agent
   - 迷ったら → Auto

### 開発者向け

1. **実行計画の品質**: `createPlan()` の精度を高める
2. **ツール呼び出しの最適化**: 必要最小限のツール呼び出し
3. **エラーハンドリング**: 各ステップでの失敗を適切に処理
4. **進捗の可視化**: ユーザーに分かりやすいフィードバック

## トラブルシューティング

### Agentモードが遅い
- 実行計画のステップ数が多すぎる可能性
- タスクをより明確に、シンプルに指示する

### 間違ったモードが選ばれる (Autoモード)
- より具体的な指示を与える
- 手動でモードを選択する

### ステップが失敗する
- ツールに必要なパラメータが不足している可能性
- より詳細な情報を指示に含める

## 今後の拡張

- [ ] ストリーミング応答対応 (リアルタイム進捗表示)
- [ ] 実行計画のプレビューと承認機能
- [ ] ステップのリトライ機能
- [ ] 並列実行サポート
- [ ] カスタムツールの追加
