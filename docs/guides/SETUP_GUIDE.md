# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ - åˆ†é›¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€AIã‚µãƒ¼ãƒ“ã‚¹ã¨MCPã‚µãƒ¼ãƒãƒ¼ã‚’åˆ†é›¢ã—ãŸæ–°ã—ã„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI Service (localhost:8787)                        â”‚
â”‚  - ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ (Google/LINE OAuth)                  â”‚
â”‚  - AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (LangGraph)                        â”‚
â”‚  - MCP ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œ (DBä¿å­˜)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ Bearer Token (DB-based)
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MCP Server (localhost:8788)                        â”‚
â”‚  - ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ (DBç…§åˆ)                              â”‚
â”‚  - ãƒ“ã‚¸ãƒã‚¹ãƒ„ãƒ¼ãƒ« (äºˆç´„/å•†å“/æ³¨æ–‡/ãƒ•ã‚©ãƒ¼ãƒ )            â”‚
â”‚  - ç®¡ç†è€…èªè¨¼ (Google OAuth)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL Database (å…±æœ‰)                          â”‚
â”‚  - ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±                                       â”‚
â”‚  - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†                                     â”‚
â”‚  - MCPã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” èªè¨¼æ–¹å¼

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€**DBãƒ™ãƒ¼ã‚¹ã®ãƒˆãƒ¼ã‚¯ãƒ³èªè¨¼**ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

### ç‰¹å¾´
- âœ… ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ©ãƒ³ãƒ€ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ä¸€å…ƒç®¡ç†
- âœ… æœ‰åŠ¹æœŸé™ã¨ã‚¹ã‚³ãƒ¼ãƒ—ã‚’DBä¸Šã§ç®¡ç†
- âœ… RSAéµãƒšã‚¢ã®ç”Ÿæˆãƒ»ç®¡ç†ãŒä¸è¦
- âœ… ã‚·ãƒ³ãƒ—ãƒ«ã§ç†è§£ã—ã‚„ã™ã„å®Ÿè£…

è©³ç´°ã¯ [èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ç°¡ç´ åŒ–ãƒ¬ãƒãƒ¼ãƒˆ](../reports/AUTH_SIMPLIFICATION.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### 1. AI Service ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```powershell
cd packages/agent

# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼
cp .dev.vars.example .dev.vars

# .dev.vars ã‚’ç·¨é›†
notepad .dev.vars
```

`.dev.vars` ã«ä»¥ä¸‹ã‚’è¨­å®š:
```env
OPENAI_API_KEY=sk-your-openai-api-key
DATABASE_URL=postgresql://user:password@localhost:5432/agent
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
GOOGLE_REDIRECT_URI=http://localhost:8787/auth/callback/google

# MCP Server URL (for calling MCP tools)
MCP_SERVER_URL=http://localhost:8788

# Frontend URL (for redirects after OAuth)
FRONTEND_URL=http://localhost:8787
```

### 2. MCP Server ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```powershell
cd packages/mcp-server

# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼
cp .dev.vars.example .dev.vars

# .dev.vars ã‚’ç·¨é›†
notepad .dev.vars
```

`.dev.vars` ã«ä»¥ä¸‹ã‚’è¨­å®š:
```env
DATABASE_URL=postgresql://user:password@localhost:5432/agent

# MCPç®¡ç†è€…ç”¨ã®Google OAuth (AI Serviceã¨ã¯åˆ¥ã®Credentialsæ¨å¥¨)
MCP_GOOGLE_CLIENT_ID=your-mcp-google-client-id
MCP_GOOGLE_CLIENT_SECRET=your-mcp-google-client-secret
MCP_GOOGLE_REDIRECT_URI=http://localhost:8788/auth/callback/google

# CORSè¨­å®š
ALLOWED_ORIGINS=http://localhost:8787,http://localhost:5173
```

### 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```powershell
cd packages/database

# Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”Ÿæˆ
npm run generate

# ã‚¹ã‚­ãƒ¼ãƒã‚’DBã«ãƒ—ãƒƒã‚·ãƒ¥
npm run push

# ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
npm run seed
```

## ğŸš€ èµ·å‹•

### ã‚¿ãƒ¼ãƒŸãƒŠãƒ«1: AI Service

```powershell
cd packages/agent
npm run dev
```

http://localhost:8787 ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

### ã‚¿ãƒ¼ãƒŸãƒŠãƒ«2: MCP Server

```powershell
cd packages/mcp-server
npm run dev
```

http://localhost:8788 ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

### ã‚¿ãƒ¼ãƒŸãƒŠãƒ«3: Prisma Studio (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)

```powershell
cd packages/database
npm run studio
```

http://localhost:5555 ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é–²è¦§

## ğŸ§ª å‹•ä½œç¢ºèª

### 1. AI Service ã®èªè¨¼ãƒ†ã‚¹ãƒˆ

```powershell
# ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã
start http://localhost:8787

# Google OAuth ãƒ­ã‚°ã‚¤ãƒ³
start http://localhost:8787/auth/login/google
```

### 2. MCP Token ç™ºè¡Œãƒ†ã‚¹ãƒˆ

```powershell
# ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
curl http://localhost:8787/auth/mcp-token `
  -X POST `
  -H "Cookie: session=YOUR_SESSION_COOKIE"
```

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:
```json
{
  "token": "k7j2h3g4f5d6s7a8q9w0e1r2t3y4u5i6...",
  "expiresIn": 3600,
  "tokenType": "Bearer",
  "scope": ["booking:read", "booking:create", "product:read", "order:create"]
}
```

### 3. MCP Server ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ

```powershell
# å…¬é–‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (èªè¨¼ä¸è¦)
curl http://localhost:8788/mcp/tools/product/search?q=test

# èªè¨¼ãŒå¿…è¦ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (ãƒˆãƒ¼ã‚¯ãƒ³å¿…è¦)
$token = "YOUR_MCP_TOKEN"
curl http://localhost:8788/mcp/tools/booking/create `
  -X POST `
  -H "Authorization: Bearer $token" `
  -H "Content-Type: application/json" `
  -d '{\"serviceId\": \"srv_123\", \"date\": \"2025-10-15\", \"time\": \"10:00\"}'
```

### 4. MCP ç®¡ç†è€…èªè¨¼ãƒ†ã‚¹ãƒˆ

```powershell
# ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã
start http://localhost:8788/auth/login/google
```

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**: MCP Serverã§ "Invalid token" ã‚¨ãƒ©ãƒ¼

**è§£æ±ºç­–**:
1. ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœ‰åŠ¹æœŸé™å†…ã‹ç¢ºèªï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1æ™‚é–“ï¼‰
2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã® `mcp_access_tokens` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèª
3. ä¸¡ã‚µãƒ¼ãƒ“ã‚¹ãŒåŒã˜ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã—ã¦ã„ã‚‹ã‹ç¢ºèª

```powershell
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèª
psql $env:DATABASE_URL -c "SELECT * FROM mcp_access_tokens WHERE token = 'YOUR_TOKEN';"
```

### CORS ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**: ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã« CORS ã‚¨ãƒ©ãƒ¼

**è§£æ±ºç­–**:
1. MCP Server ã® `ALLOWED_ORIGINS` ã« AI Service ã® URL ã‚’è¿½åŠ 
2. ä¸¡æ–¹ã®ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**: Database connection failed

**è§£æ±ºç­–**:
1. PostgreSQLãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª
2. `DATABASE_URL` ãŒæ­£ã—ã„ã‹ç¢ºèª
3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª

```powershell
# PostgreSQLæ¥ç¶šãƒ†ã‚¹ãƒˆ
psql $env:DATABASE_URL
```

## ğŸ“š æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

- [MCP Authentication Guide](./MCP_AUTH.md) - èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®è©³ç´°
- [Separation Architecture](../architecture/SEPARATION_ARCHITECTURE.md) - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è©³ç´°
- [MCP Usage Guide](./MCP_USAGE.md) - MCPãƒ„ãƒ¼ãƒ«ã®ä½¿ã„æ–¹

## ğŸ” æœ¬ç•ªç’°å¢ƒã¸ã®å±•é–‹

### Cloudflare Workers ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

**AI Service**:
```powershell
cd packages/agent

# Secretsã®è¨­å®š
wrangler secret put OPENAI_API_KEY
wrangler secret put GOOGLE_CLIENT_SECRET
wrangler secret put DATABASE_URL
wrangler secret put STRIPE_SECRET_KEY

# ãƒ‡ãƒ—ãƒ­ã‚¤
npm run deploy
```

**MCP Server**:
```powershell
cd packages/mcp-server

# Secretsã®è¨­å®š
wrangler secret put MCP_GOOGLE_CLIENT_SECRET
wrangler secret put DATABASE_URL

# ãƒ‡ãƒ—ãƒ­ã‚¤
npm run deploy
```

### ç’°å¢ƒå¤‰æ•°ã®æ›´æ–°

æœ¬ç•ªç’°å¢ƒã§ã¯ã€URLã‚’æœ¬ç•ªãƒ‰ãƒ¡ã‚¤ãƒ³ã«å¤‰æ›´:
- `GOOGLE_REDIRECT_URI`: `https://your-domain.com/auth/callback/google`
- `MCP_GOOGLE_REDIRECT_URI`: `https://mcp.your-domain.com/auth/callback/google`
- `MCP_SERVER_URL`: `https://mcp.your-domain.com`
- `ALLOWED_ORIGINS`: `https://your-domain.com`
- `FRONTEND_URL`: `https://your-domain.com`
